# 数据库表结构分析报告

## 📊 概述

本报告分析了课程管理系统的数据库表结构，识别了共用的表，并提供了优化整合方案。

## 🔍 原始表结构分析

### 1. 用户模块重复表
**问题**：存在4个用户相关表，功能重复
- `user_info` - 基础用户信息
- `admin_user` - 管理员用户
- `enterprise_user` - 企业用户  
- `system_user` - 系统用户

**整合方案**：合并为统一的 `users` 表，通过 `user_type` 字段区分用户类型

### 2. 审核功能重复表
**问题**：存在3个审核相关表，功能分散
- `course_review_history` - 课程审核历史
- `meeting_review_record` - 会议审核记录
- `review` - 课程审核表

**整合方案**：合并为统一的 `audit_records` 表，通过 `resource_type` 字段区分审核对象

### 3. 日志功能重复表
**问题**：存在2个日志表，功能重复
- `user_view_log` - 用户浏览日志（仅新闻）
- `user_operation_log` - 用户操作日志（仅新闻）

**整合方案**：扩展为统一的日志表，支持所有模块的日志记录

### 4. 历史记录重复表
**问题**：存在2个历史记录表
- `course_history` - 课程历史
- `user_modify_history` - 用户修改历史

**整合方案**：合并为统一的 `history_records` 表

## 🎯 优化后的表结构

### 1. 统一用户模块

#### `users` 表（整合所有用户类型）
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    real_name VARCHAR(100),
    email VARCHAR(255),
    phone VARCHAR(20),
    user_type VARCHAR(20) NOT NULL, -- ADMIN, ENTERPRISE, NORMAL, SYSTEM
    status INTEGER DEFAULT 1,
    department VARCHAR(100),
    nickname VARCHAR(100),
    is_remembered BOOLEAN DEFAULT FALSE,
    enterprise_id VARCHAR(64),
    dynamic_code VARCHAR(20),
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted INTEGER DEFAULT 0
);
```

**优势**：
- 统一用户管理，减少表数量
- 通过 `user_type` 字段区分用户角色
- 支持企业用户关联企业信息
- 统一的状态管理和软删除

#### `enterprise` 表（企业信息）
```sql
CREATE TABLE enterprise (
    enterprise_id VARCHAR(30) PRIMARY KEY,
    enterprise_name VARCHAR(100) NOT NULL,
    credit_code VARCHAR(30) UNIQUE,
    -- 其他企业信息字段...
);
```

### 2. 统一审核模块

#### `audit_records` 表（整合所有审核功能）
```sql
CREATE TABLE audit_records (
    id SERIAL PRIMARY KEY,
    resource_type VARCHAR(50) NOT NULL, -- COURSE, MEETING, NEWS, USER
    resource_id BIGINT NOT NULL,
    resource_name VARCHAR(255),
    action VARCHAR(50) NOT NULL, -- APPROVE, REJECT, MODIFY, DELETE
    reviewer_id BIGINT NOT NULL,
    reviewer_name VARCHAR(100),
    status VARCHAR(20) NOT NULL, -- PENDING, APPROVED, REJECTED
    comment TEXT,
    old_value TEXT,
    new_value TEXT,
    audit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**优势**：
- 统一审核流程，支持所有资源类型
- 完整的审核历史记录
- 支持审核状态跟踪
- 记录审核前后的值变化

### 3. 统一日志模块

#### `user_view_logs` 表（整合所有浏览记录）
```sql
CREATE TABLE user_view_logs (
    id SERIAL PRIMARY KEY,
    user_id BIGINT,
    resource_type VARCHAR(50) NOT NULL, -- COURSE, NEWS, MEETING
    resource_id BIGINT NOT NULL,
    resource_title VARCHAR(255),
    ip_address VARCHAR(50),
    user_agent VARCHAR(500),
    session_id VARCHAR(100),
    view_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### `user_operation_logs` 表（整合所有操作记录）
```sql
CREATE TABLE user_operation_logs (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL,
    operation_type VARCHAR(50) NOT NULL, -- CREATE, UPDATE, DELETE, PUBLISH, AUDIT
    resource_type VARCHAR(50) NOT NULL, -- COURSE, NEWS, MEETING, USER
    resource_id BIGINT NOT NULL,
    resource_title VARCHAR(255),
    operation_desc VARCHAR(500),
    old_value TEXT,
    new_value TEXT,
    ip_address VARCHAR(50),
    operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    operation_result INTEGER DEFAULT 1
);
```

**优势**：
- 统一日志记录，支持所有模块
- 完整的操作追踪
- 支持操作结果记录
- 便于数据分析和审计

### 4. 统一历史记录模块

#### `history_records` 表（整合所有历史记录）
```sql
CREATE TABLE history_records (
    id SERIAL PRIMARY KEY,
    resource_type VARCHAR(50) NOT NULL, -- COURSE, USER, ENTERPRISE
    resource_id BIGINT NOT NULL,
    action VARCHAR(50) NOT NULL, -- VIEW, MODIFY, DELETE
    user_id BIGINT,
    old_value TEXT,
    new_value TEXT,
    record_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**优势**：
- 统一历史记录管理
- 支持所有资源类型的历史追踪
- 记录值变化历史

## 📈 优化效果对比

### 表数量减少
| 模块 | 优化前 | 优化后 | 减少数量 |
|------|--------|--------|----------|
| 用户模块 | 4个表 | 2个表 | 50% |
| 审核模块 | 3个表 | 1个表 | 67% |
| 日志模块 | 2个表 | 2个表 | 0% |
| 历史模块 | 2个表 | 1个表 | 50% |
| **总计** | **11个表** | **6个表** | **45%** |

### 功能增强
1. **统一管理**：所有用户类型统一管理
2. **扩展性**：支持新的资源类型和操作类型
3. **一致性**：统一的数据结构和命名规范
4. **可维护性**：减少重复代码和表结构

## 🔧 数据迁移方案

### 1. 用户数据迁移
```sql
-- 迁移管理员用户
INSERT INTO users (username, password, real_name, email, phone, user_type, status, department, nickname)
SELECT account, password, real_name, email, phone, 'ADMIN', 1, department, nickname
FROM admin_user;

-- 迁移企业用户
INSERT INTO users (username, password, real_name, email, phone, user_type, status, enterprise_id, department, nickname)
SELECT account, password, real_name, email, phone, 'ENTERPRISE', 1, enterprise_id, department, nickname
FROM enterprise_user;

-- 迁移系统用户
INSERT INTO users (username, password, real_name, email, phone, user_type, status, department, nickname)
SELECT account, password, real_name, email, phone, 'SYSTEM', 1, department, nickname
FROM system_user;
```

### 2. 审核数据迁移
```sql
-- 迁移课程审核记录
INSERT INTO audit_records (resource_type, resource_id, resource_name, action, reviewer_id, reviewer_name, status, comment, audit_time)
SELECT 'COURSE', course_id, '课程审核', 'APPROVE', reviewer_id, reviewer_name, status, review_comment, review_time
FROM course_review_history;

-- 迁移会议审核记录
INSERT INTO audit_records (resource_type, resource_id, resource_name, action, reviewer_id, reviewer_name, status, comment, audit_time)
SELECT 'MEETING', meeting_id, meeting_name, 'APPROVE', reviewer_id, reviewer_name, status, review_comment, review_time
FROM meeting_review_record;
```

### 3. 日志数据迁移
```sql
-- 迁移浏览日志
INSERT INTO user_view_logs (user_id, resource_type, resource_id, resource_title, ip_address, session_id, view_time)
SELECT user_id, 'NEWS', news_id, '新闻浏览', ip_address, session_id, view_time
FROM user_view_log;

-- 迁移操作日志
INSERT INTO user_operation_logs (user_id, operation_type, resource_type, resource_id, resource_title, operation_desc, ip_address, operation_time)
SELECT user_id, operation_type, resource_type, resource_id, '新闻操作', operation_desc, ip_address, operation_time
FROM user_operation_log;
```

## 🚀 实施建议

### 1. 分阶段实施
1. **第一阶段**：创建新的优化表结构
2. **第二阶段**：数据迁移和验证
3. **第三阶段**：更新应用程序代码
4. **第四阶段**：删除旧表结构

### 2. 代码更新要点
- 更新用户相关的DAO层代码
- 修改审核流程的业务逻辑
- 调整日志记录的实现方式
- 更新历史记录的处理逻辑

### 3. 测试验证
- 数据完整性验证
- 功能回归测试
- 性能测试
- 用户验收测试

## 📋 总结

通过本次数据库表结构优化，我们实现了：

1. **减少45%的表数量**，从11个表减少到6个表
2. **统一了用户管理**，支持所有用户类型的统一管理
3. **整合了审核功能**，提供统一的审核流程
4. **扩展了日志功能**，支持所有模块的日志记录
5. **提高了系统可维护性**，减少了重复代码和表结构

优化后的数据库结构更加清晰、统一，便于维护和扩展，为系统的长期发展奠定了良好的基础。 