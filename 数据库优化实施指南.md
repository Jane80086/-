# 数据库优化实施指南

## 📋 概述

本指南详细说明了如何实施数据库表结构优化，从旧的多表结构迁移到新的统一表结构。

## 🎯 优化目标

1. **减少表数量**：从11个表减少到6个表（减少45%）
2. **统一用户管理**：整合4个用户表为1个统一表
3. **统一审核流程**：整合3个审核表为1个统一表
4. **扩展日志功能**：支持所有模块的日志记录
5. **提高可维护性**：减少重复代码和表结构

## 📊 优化前后对比

### 表结构变化
| 模块 | 优化前 | 优化后 | 变化 |
|------|--------|--------|------|
| 用户模块 | `user_info`, `admin_user`, `enterprise_user`, `system_user` | `users`, `enterprise` | 4→2 |
| 审核模块 | `course_review_history`, `meeting_review_record`, `review` | `audit_records` | 3→1 |
| 日志模块 | `user_view_log`, `user_operation_log` | `user_view_logs`, `user_operation_logs` | 2→2 |
| 历史模块 | `course_history`, `user_modify_history` | `history_records` | 2→1 |
| **总计** | **11个表** | **6个表** | **45%减少** |

## 🚀 实施步骤

### 第一阶段：准备工作

#### 1.1 环境检查
```bash
# 检查数据库连接
psql -h localhost -U username -d course_manager -c "SELECT version();"

# 检查当前表结构
psql -h localhost -U username -d course_manager -c "\dt"

# 检查数据量
psql -h localhost -U username -d course_manager -c "
SELECT 
    schemaname,
    tablename,
    n_tup_ins as inserts,
    n_tup_upd as updates,
    n_tup_del as deletes
FROM pg_stat_user_tables
ORDER BY n_tup_ins DESC;
"
```

#### 1.2 数据备份
```bash
# 创建完整备份
pg_dump -h localhost -U username -d course_manager > backup_before_optimization.sql

# 创建时间戳备份
pg_dump -h localhost -U username -d course_manager > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 1.3 创建测试环境
```bash
# 创建测试数据库
createdb -h localhost -U username course_manager_test

# 恢复数据到测试环境
psql -h localhost -U username -d course_manager_test < backup_before_optimization.sql
```

### 第二阶段：创建新表结构

#### 2.1 执行优化后的数据库脚本
```bash
# 在测试环境中执行
psql -h localhost -U username -d course_manager_test < optimized_unified_database.sql

# 验证表创建
psql -h localhost -U username -d course_manager_test -c "\dt"
```

#### 2.2 验证表结构
```sql
-- 检查新表是否创建成功
SELECT table_name, table_type 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- 检查表字段
SELECT 
    table_name,
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns 
WHERE table_schema = 'public' 
ORDER BY table_name, ordinal_position;
```

### 第三阶段：数据迁移

#### 3.1 执行数据迁移脚本
```bash
# 在测试环境中执行迁移
psql -h localhost -U username -d course_manager_test < 数据迁移脚本.sql
```

#### 3.2 验证数据迁移
```sql
-- 验证用户数据
SELECT '用户数据验证' as check_type;
SELECT user_type, COUNT(*) FROM users GROUP BY user_type;

-- 验证审核数据
SELECT '审核数据验证' as check_type;
SELECT resource_type, status, COUNT(*) FROM audit_records GROUP BY resource_type, status;

-- 验证日志数据
SELECT '日志数据验证' as check_type;
SELECT resource_type, COUNT(*) FROM user_view_logs GROUP BY resource_type;

-- 验证外键关联
SELECT '外键关联验证' as check_type;
SELECT 
    'courses' as table_name,
    COUNT(*) as total_records,
    COUNT(instructor_id) as linked_records
FROM courses
UNION ALL
SELECT 
    'meetings' as table_name,
    COUNT(*) as total_records,
    COUNT(creator_id) as linked_records
FROM meetings
UNION ALL
SELECT 
    'news' as table_name,
    COUNT(*) as total_records,
    COUNT(user_id) as linked_records
FROM news;
```

### 第四阶段：功能测试

#### 4.1 基础功能测试
```sql
-- 测试用户登录
SELECT * FROM users WHERE username = 'admin' AND password = 'e10adc3949ba59abbe56e057f20f883e';

-- 测试课程查询
SELECT c.*, u.real_name as instructor_name 
FROM courses c 
JOIN users u ON c.instructor_id = u.id 
WHERE c.status = 'PUBLISHED';

-- 测试会议查询
SELECT m.*, u.real_name as creator_name 
FROM meetings m 
JOIN users u ON m.creator_id = u.id 
WHERE m.status = 1;

-- 测试新闻查询
SELECT n.*, u.real_name as author_name 
FROM news n 
JOIN users u ON n.user_id = u.id 
WHERE n.status = 1;
```

#### 4.2 审核功能测试
```sql
-- 测试审核记录查询
SELECT 
    ar.*,
    u.real_name as reviewer_real_name
FROM audit_records ar
JOIN users u ON ar.reviewer_id = u.id
WHERE ar.resource_type = 'COURSE'
ORDER BY ar.audit_time DESC;
```

#### 4.3 日志功能测试
```sql
-- 测试浏览日志
SELECT 
    uvl.*,
    u.real_name as user_real_name
FROM user_view_logs uvl
JOIN users u ON uvl.user_id = u.id
WHERE uvl.resource_type = 'NEWS'
ORDER BY uvl.view_time DESC
LIMIT 10;

-- 测试操作日志
SELECT 
    uol.*,
    u.real_name as user_real_name
FROM user_operation_logs uol
JOIN users u ON uol.user_id = u.id
ORDER BY uol.operation_time DESC
LIMIT 10;
```

### 第五阶段：生产环境部署

#### 5.1 生产环境准备
```bash
# 停止应用程序
sudo systemctl stop course-manager

# 创建生产环境备份
pg_dump -h localhost -U username -d course_manager > production_backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 5.2 执行生产环境迁移
```bash
# 执行优化脚本
psql -h localhost -U username -d course_manager < optimized_unified_database.sql

# 执行数据迁移
psql -h localhost -U username -d course_manager < 数据迁移脚本.sql
```

#### 5.3 验证生产环境
```sql
-- 验证数据完整性
SELECT '生产环境验证' as environment;
SELECT COUNT(*) as total_users FROM users;
SELECT COUNT(*) as total_courses FROM courses;
SELECT COUNT(*) as total_meetings FROM meetings;
SELECT COUNT(*) as total_news FROM news;
```

### 第六阶段：应用程序更新

#### 6.1 更新DAO层代码
需要更新的文件：
- `UserDao.java` - 更新用户相关操作
- `AuditDao.java` - 更新审核相关操作
- `LogDao.java` - 更新日志相关操作
- `HistoryDao.java` - 更新历史记录相关操作

#### 6.2 更新Service层代码
需要更新的文件：
- `UserService.java` - 更新用户服务逻辑
- `AuditService.java` - 更新审核服务逻辑
- `LogService.java` - 更新日志服务逻辑

#### 6.3 更新配置文件
```yaml
# application.yml
spring:
  datasource:
    url: jdbc:kingbase8://localhost:54321/course_manager
    username: username
    password: password
    driver-class-name: com.kingbase8.Driver
```

### 第七阶段：清理和优化

#### 7.1 删除旧表（可选）
```sql
-- 注意：请在确认所有功能正常后执行
DROP TABLE IF EXISTS admin_user CASCADE;
DROP TABLE IF EXISTS enterprise_user CASCADE;
DROP TABLE IF EXISTS system_user CASCADE;
DROP TABLE IF EXISTS user_info CASCADE;
DROP TABLE IF EXISTS course_review_history CASCADE;
DROP TABLE IF EXISTS meeting_review_record CASCADE;
DROP TABLE IF EXISTS review CASCADE;
DROP TABLE IF EXISTS user_view_log CASCADE;
DROP TABLE IF EXISTS user_operation_log CASCADE;
DROP TABLE IF EXISTS course_history CASCADE;
DROP TABLE IF EXISTS user_modify_history CASCADE;
```

#### 7.2 性能优化
```sql
-- 更新统计信息
ANALYZE;

-- 检查索引使用情况
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

## ⚠️ 注意事项

### 1. 数据安全
- **必须备份**：执行前必须创建完整数据库备份
- **测试环境**：先在测试环境验证所有功能
- **分批执行**：建议分阶段执行，每阶段验证后再继续

### 2. 应用程序兼容性
- **代码更新**：需要同步更新应用程序代码
- **API变更**：可能需要更新API接口
- **前端适配**：可能需要更新前端代码

### 3. 性能考虑
- **迁移时间**：大数据量迁移可能需要较长时间
- **锁表影响**：迁移过程中可能影响正常业务
- **索引重建**：新表结构需要重建索引

### 4. 回滚准备
- **备份文件**：保留所有备份文件
- **回滚脚本**：准备回滚脚本
- **监控告警**：设置监控和告警机制

## 🔄 回滚方案

### 1. 快速回滚
```bash
# 停止应用程序
sudo systemctl stop course-manager

# 恢复数据库
psql -h localhost -U username -d course_manager < production_backup_YYYYMMDD_HHMMSS.sql

# 重启应用程序
sudo systemctl start course-manager
```

### 2. 代码回滚
```bash
# 回滚到之前的代码版本
git checkout <previous-commit-hash>

# 重新部署
mvn clean package
sudo systemctl restart course-manager
```

## 📈 监控指标

### 1. 性能指标
- 数据库响应时间
- 查询执行时间
- 连接池使用情况
- 磁盘空间使用

### 2. 业务指标
- 用户登录成功率
- 课程访问量
- 会议创建数量
- 新闻发布数量

### 3. 错误指标
- 数据库错误率
- 应用程序错误率
- 接口响应错误率

## 📞 支持联系

如果在实施过程中遇到问题，请联系：
- **技术负责人**：[姓名] - [电话] - [邮箱]
- **数据库管理员**：[姓名] - [电话] - [邮箱]
- **运维团队**：[团队邮箱]

## 📋 检查清单

### 实施前检查
- [ ] 数据库备份完成
- [ ] 测试环境准备就绪
- [ ] 应用程序代码更新完成
- [ ] 团队通知完成
- [ ] 监控告警配置完成

### 实施中检查
- [ ] 新表结构创建成功
- [ ] 数据迁移完成
- [ ] 数据验证通过
- [ ] 功能测试通过
- [ ] 性能测试通过

### 实施后检查
- [ ] 生产环境部署成功
- [ ] 应用程序正常运行
- [ ] 监控指标正常
- [ ] 用户反馈正常
- [ ] 文档更新完成

---

**注意**：本指南仅供参考，具体实施时请根据实际情况调整。建议在实施前进行充分的测试和验证。 