<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.system.repository.UserManagementMapper">

    <resultMap id="userResultMap" type="com.system.entity.EnterpriseUser">
        <result property="userId" column="user_id"/>
        <result property="realName" column="real_name"/>
        <result property="account" column="account"/>
        <result property="nickname" column="nickname"/>
        <result property="enterpriseId" column="enterprise_id"/>
        <result property="enterpriseName" column="enterprise_name"/>
        <result property="enterpriseType" column="enterprise_type"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- 查询用户列表 -->
    <select id="getUserList" resultMap="userResultMap" parameterType="com.system.dto.UserQueryDTO">
        SELECT eu.*, e.enterprise_name, e.enterprise_type
        FROM enterprise_user eu
        LEFT JOIN enterprise e ON eu.enterprise_id = e.enterprise_id
        WHERE 1=1
        <if test="realName != null and realName != ''">
            AND eu.real_name LIKE '%' || #{realName} || '%'
        </if>
        <if test="account != null and account != ''">
            AND eu.account LIKE '%' || #{account} || '%'
        </if>
        <if test="enterpriseName != null and enterpriseName != ''">
            AND e.enterprise_name LIKE '%' || #{enterpriseName} || '%'
        </if>
        <if test="enterpriseType != null and enterpriseType != ''">
            AND e.enterprise_type = #{enterpriseType}
        </if>
        <if test="phone != null and phone != ''">
            AND eu.phone LIKE '%' || #{phone} || '%'
        </if>
        <if test="email != null and email != ''">
            AND eu.email LIKE '%' || #{email} || '%'
        </if>
        <if test="status != null and status != ''">
            AND eu.status = #{status}
        </if>
        <if test="size != null and page != null">
            LIMIT #{size} OFFSET ${(page - 1) * size}
        </if>
    </select>

    <!-- 查询用户总数 -->
    <select id="getUserCount" resultType="int" parameterType="com.system.dto.UserQueryDTO">
        SELECT COUNT(*) 
        FROM enterprise_user eu
        LEFT JOIN enterprise e ON eu.enterprise_id = e.enterprise_id
        WHERE 1=1
        <if test="realName != null and realName != ''">
            AND eu.real_name LIKE '%' || #{realName} || '%'
        </if>
        <if test="account != null and account != ''">
            AND eu.account LIKE '%' || #{account} || '%'
        </if>
        <if test="enterpriseName != null and enterpriseName != ''">
            AND e.enterprise_name LIKE '%' || #{enterpriseName} || '%'
        </if>
        <if test="enterpriseType != null and enterpriseType != ''">
            AND e.enterprise_type = #{enterpriseType}
        </if>
        <if test="phone != null and phone != ''">
            AND eu.phone LIKE '%' || #{phone} || '%'
        </if>
        <if test="email != null and email != ''">
            AND eu.email LIKE '%' || #{email} || '%'
        </if>
        <if test="status != null and status != ''">
            AND eu.status = #{status}
        </if>
    </select>

    <!-- 根据ID查询用户 -->
    <select id="getUserById" resultMap="userResultMap" parameterType="string">
        SELECT eu.*, e.enterprise_name, e.enterprise_type
        FROM enterprise_user eu
        LEFT JOIN enterprise e ON eu.enterprise_id = e.enterprise_id
        WHERE eu.user_id = #{userId}
    </select>

    <!-- 创建用户 -->
    <insert id="createUserByTemplate" parameterType="com.system.entity.EnterpriseUser">
        INSERT INTO enterprise_user (
            user_id, real_name, account, password, enterprise_id,
            phone, email, status, create_time, update_time
        ) VALUES (
            #{userId}, #{realName}, #{account}, #{password}, #{enterpriseId},
            #{phone}, #{email}, #{status}, NOW(), NOW()
        )
    </insert>

    <!-- 记录用户修改历史 -->
    <insert id="recordModifyHistory" parameterType="com.system.entity.UserModifyHistory">
        INSERT INTO user_modify_history (
            history_id, user_id, field_name, old_value, new_value, operator_id, modify_time
        ) VALUES (
            #{historyId}, #{userId}, #{fieldName}, #{oldValue}, #{newValue}, #{operatorId}, NOW()
        )
    </insert>

    <!-- 查询用户模板 -->
    <select id="getUserTemplate" resultType="com.system.entity.UserTemplate" parameterType="string">
        SELECT * FROM user_template WHERE template_id = #{templateId}
    </select>

    <!-- 查询所有用户模板 -->
    <select id="getAllTemplates" resultType="com.system.entity.UserTemplate">
        SELECT * FROM user_template
    </select>

    <!-- 分配权限 -->
    <insert id="addPermission">
        INSERT INTO user_permission (user_id, permission_code) VALUES (#{userId}, #{permission})
    </insert>

    <!-- 继承角色权限 -->
    <insert id="inheritPermissions">
        INSERT INTO user_permission (user_id, permission_code)
        SELECT #{userId}, p.permission_code
        FROM role_permission rp
        JOIN role r ON rp.role_id = r.role_id
        JOIN permission p ON rp.permission_id = p.permission_id
        WHERE r.role_name = #{roleName}
    </insert>

    <!-- 更新用户信息 -->
    <update id="updateUser" parameterType="com.system.entity.EnterpriseUser">
        UPDATE enterprise_user SET
            real_name = #{realName},
            account = #{account},
            password = #{password},
            nickname = #{nickname},
            enterprise_id = #{enterpriseId},
            phone = #{phone},
            email = #{email},
            status = #{status},
            update_time = NOW()
        WHERE user_id = #{userId}
    </update>

    <!-- 删除用户 -->
    <delete id="deleteUserById" parameterType="string">
        DELETE FROM enterprise_user WHERE user_id = #{userId}
    </delete>

    <!-- 分页查询用户修改历史 -->
    <select id="getUserModifyHistoryPaged" resultType="com.system.entity.UserModifyHistory" parameterType="com.system.dto.UserHistoryQueryDTO">
        SELECT 
            history_id,
            user_id,
            field_name,
            old_value,
            new_value,
            operator_id,
            modify_time
        FROM user_modify_history
        <where>
            <if test="userId != null and userId != ''">
                AND user_id = #{userId}
            </if>
            <if test="operatorId != null and operatorId != ''">
                AND operator_id = #{operatorId}
            </if>
            <if test="fieldName != null and fieldName != ''">
                AND field_name = #{fieldName}
            </if>
            <if test="startTime != null and startTime != ''">
                AND modify_time >= #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND modify_time &lt;= #{endTime}
            </if>
        </where>
        ORDER BY modify_time DESC
        <if test="page != null and pageSize != null">
            LIMIT #{pageSize} OFFSET ${(page - 1) * pageSize}
        </if>
    </select>

    <!-- 统计用户修改历史总数 -->
    <select id="countUserModifyHistory" resultType="int" parameterType="com.system.dto.UserHistoryQueryDTO">
        SELECT COUNT(*)
        FROM user_modify_history
        <where>
            <if test="userId != null and userId != ''">
                AND user_id = #{userId}
            </if>
            <if test="operatorId != null and operatorId != ''">
                AND operator_id = #{operatorId}
            </if>
            <if test="fieldName != null and fieldName != ''">
                AND field_name = #{fieldName}
            </if>
            <if test="startTime != null and startTime != ''">
                AND modify_time >= #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND modify_time &lt;= #{endTime}
            </if>
        </where>
    </select>

    <!-- 根据历史ID获取历史记录 -->
    <select id="getHistoryById" resultType="com.system.entity.UserModifyHistory" parameterType="string">
        SELECT 
            history_id,
            user_id,
            field_name,
            old_value,
            new_value,
            operator_id,
            modify_time
        FROM user_modify_history 
        WHERE history_id = #{historyId}
    </select>

</mapper> 